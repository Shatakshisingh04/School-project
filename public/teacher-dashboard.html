<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard - Attendance System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
/* Mobile-First Responsive Design */
@media screen and (max-width: 768px) {
    body {
        font-size: 14px;
    }
    
    .header {
        padding: 10px;
    }
    
    .header-content {
        flex-direction: column;
        gap: 10px;
        text-align: center;
    }
    
    .container {
        padding: 10px;
    }
    
    .nav-tabs {
        overflow-x: auto;
        scrollbar-width: none;
    }
    
    .nav-tabs::-webkit-scrollbar {
        display: none;
    }
    
    .tab {
        flex: 0 0 auto;
        min-width: 90px;
        padding: 12px 8px;
        font-size: 11px;
    }
    
    .section {
        padding: 15px;
    }
    
    .row {
        flex-direction: column;
        gap: 10px;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    
    .btn {
        width: 100%;
        margin: 5px 0;
    }
    
    /* Replace table with card layout on mobile */
    .table-container {
        display: none;
    }
    
    .mobile-card-list {
        display: block;
    }
}
        body {
            font-family: 'Arial', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .user-info h2 {
            margin-bottom: 5px;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 0;
        }
        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: #f8f9fa;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 600;
        }
        
        .tab:hover {
            background: #e9ecef;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        .tab-content {
            background: white;
            border-radius: 0 0 10px 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 0;
            position: relative;
        }

        .section {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 30px;
            background: white;
        }

        .section.active {
            display: block;
            position: static;
            padding: 0;
            animation: fadeIn 0.3s ease;
        }
        .section h3 {
            margin-left: 20px;
            margin-top: 15px;
            margin-bottom: 20px;
        }
        .tab-content {
            background: white;
            border-radius: 0 0 10px 10px;
            padding: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 0;
        }

        .section {
            display: none;
            padding: 30px;
            padding-top: 15px !important;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .form-group {
            margin: 15px 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a6fd8;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        .table tr:hover {
            background: #f8f9fa;
        }
        /* Mobile Card Layout */
.mobile-card-list {
    display: none;
}

.mobile-card {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
}

.mobile-card-header {
    font-weight: 600;
    margin-bottom: 5px;
    color: #333;
}

.mobile-card-row {
    display: flex;
    justify-content: space-between;
    margin: 5px 0;
    font-size: 14px;
}

.mobile-card-actions {
    margin-top: 10px;
    display: flex;
    gap: 5px;
}

.mobile-card-actions .btn {
    flex: 1;
    padding: 8px;
    font-size: 12px;
}
.mobile-attendance-btn {
    flex: 1 !important;
    width: auto !important;
    margin: 2px !important;
}

.mobile-attendance-btn.selected {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
            border-left: 4px solid #667eea;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 14px;
        }
        
        .attendance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .student-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #ddd;
            transition: all 0.3s ease;
        }
        
        .student-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .student-name {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }
        
        .attendance-options {
            display: flex;
            gap: 5px;
        }
        
        .attendance-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }
        
        .present { background: #28a745; color: white; }
        .absent { background: #dc3545; color: white; }
        .late { background: #ffc107; color: #212529; }
        
        .attendance-btn.selected {
            transform: scale(1.05);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            display: none;
        }
        
        .alert.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .row {
            display: flex;
            gap: 20px;
            align-items: end;
        }
        
        .col {
            flex: 1;
        }
        .teacher-attendance-box {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .teacher-attendance-box h3 {
          margin-bottom: 10px;
        }
        .teacher-attendance-box select {
            padding: 8px;
            margin-right: 10px;
        }
        .attendance-cell {
            text-align: center;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            padding: 8px;
            border-radius: 4px;
            background: #f8f9fa; /* Light gray background */
        }

        /* Show symbols only when selected */
        .attendance-cell.selected.present::after { 
            content: "✓"; 
            color: #28a745; 
        }
        .attendance-cell.selected.absent::after { 
            content: "✗"; 
            color: #dc3545; 
        }
        .attendance-cell.selected.late::after { 
            content: "Late"; 
            color: #ffc107; 
        }

        /* Hide the default text when not selected */
        .attendance-cell:not(.selected) {
            color: transparent;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="user-info">
                <h2>Welcome, <span id="teacherName"></span></h2>
                <p>Teacher Dashboard | Subject: <span id="teacherSubject"></span></p>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <div class="nav-tabs">
            <button class="tab active" onclick="showSection('overview')">Overview</button>
            <button class="tab" onclick="showSection('myAttendance')">My Attendance</button>
            <button class="tab" onclick="showSection('markAttendance')">Mark Student Attendance</button>
            <button class="tab" onclick="showSection('manageStudents')">Manage Students</button>
            <button class="tab" onclick="showSection('manageBatches')">Manage Batches</button>
            <button class="tab" onclick="showSection('notices')">Notices</button>
            <button class="tab" onclick="showSection('reports')">Reports</button>
        </div>

        <div class="tab-content">
            <!-- Overview Section -->
            <div id="overview" class="section active">
                <h3>Dashboard Overview</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalClasses">0</div>
                        <div class="stat-label">Total Classes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalStudents">0</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="todayAttendance">0</div>
                        <div class="stat-label">Today's Attendance Marked</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="myAttendancePercent">0%</div>
                        <div class="stat-label">My Attendance This Month</div>
                    </div>
                </div>

                <div class="card">
                    <h4>Recent Activities</h4>
                    <div id="recentActivities">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading recent activities...
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Attendance Section -->
            <div id="myAttendance" class="section">
                <h3>My Attendance</h3>
                
                <div class="card">
                    <h4>Mark My Attendance</h4>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label for="myAttendanceDate">Date:</label>
                                <input type="date" id="myAttendanceDate">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label for="myAttendanceStatus">Status:</label>
                                <select id="myAttendanceStatus">
                                    <option value="present">Present</option>
                                    <option value="absent">Absent</option>
                                    <option value="late">Late</option>
                                </select>
                            </div>
                        </div>
                        <div class="col">
                            <button class="btn btn-primary" onclick="markMyAttendance()">Mark Attendance</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h4>My Attendance History</h4>
                    <div id="myAttendanceHistory">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading attendance history...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mark Student Attendance Section -->
            <div id="markAttendance" class="section">
                <!-- Teacher Attendance Section -->
                <div class="teacher-attendance-box">
                    <h3>Mark Your Own Attendance</h3>
                    <select id="teacherStatusSelect">
                        <option value="">-- Select Status --</option>
                        <option value="present">Present</option>
                        <option value="absent">Absent</option>
                        <option value="late">Late</option>
                    </select>
                    <button class="btn" onclick="submitTeacherAttendance()">Submit</button>
                </div>
                <h3>Mark Student Attendance</h3>
                
                <div class="card">
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label for="attendanceClass">Select Class:</label>
                                <select id="attendanceClass" onchange="loadStudentsForAttendance()">
                                    <option value="">Select Class</option>
                                </select>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label for="attendanceDate">Date:</label>
                                <input type="date" id="attendanceDate">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label for="attendanceSubject">Subject:</label>
                                <input type="text" id="attendanceSubject" placeholder="Enter subject">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert" id="attendanceAlert"></div>

                <div id="studentsForAttendance">
                    <!-- Students will be loaded here -->
                </div>

                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn btn-success" onclick="submitAttendance()" id="submitAttendanceBtn" style="display: none;">
                        Submit Attendance
                    </button>
                </div>
            </div>

            <!-- Manage Students Section -->
            <div id="manageStudents" class="section">
                <h3>Manage Students</h3>
                
                <div class="card">
                    <div class="row">
                        <div class="col">
                            <h4>Add New Student</h4>
                        </div>
                        <div class="col" style="text-align: right;">
                            <button class="btn btn-primary" onclick="showAddStudentModal()">Add Student</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="form-group">
                        <label for="studentClassFilter">Filter by Class:</label>
                        <select id="studentClassFilter" onchange="loadStudentsList()">
                            <option value="">All Classes</option>
                        </select>
                    </div>

                    <div id="studentsList">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading students...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manage Batches Section -->
            <div id="manageBatches" class="section">
                <h3>Manage Batches/Classes</h3>
                
                <div class="card">
                    <div class="row">
                        <div class="col">
                            <h4>My Classes</h4>
                        </div>
                        <div class="col" style="text-align: right;">
                            <button class="btn btn-primary" onclick="showAddBatchModal()">Create New Batch</button>
                        </div>
                    </div>
                </div>

                <div id="batchesList">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading batches...
                    </div>
                </div>
            </div>
            </div>

            <!-- Notices Section -->
            <div id="notices" class="section">
                <h3>Notices & Announcements</h3>
    
                <div class="card">
                    <div class="row">
                        <div class="col">
                            <h4>Manage Notices</h4>
                        </div>
                        <div class="col" style="text-align: right;">
                            <button class="btn btn-primary" onclick="showAddNoticeModal()">Create New Notice</button>
                        </div>
                    </div>
        
                    <div class="row">
                        <div class="col">
                        <div class="form-group">
                            <label for="noticeClassFilter">Filter by Class:</label>
                            <select id="noticeClassFilter" onchange="loadNotices()">
                                <option value="">All Classes</option>
                            </select>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label for="noticeTypeFilter">Filter by Type:</label>
                            <select id="noticeTypeFilter" onchange="loadNotices()">
                                <option value="">All Types</option>
                                <option value="homework">Homework</option>
                                <option value="announcement">Announcement</option>
                                <option value="event">Event</option>
                                <option value="general">General</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div id="noticesList">
                <div class="loading">
                    <div class="spinner"></div>
                        Loading notices...
                    </div>
                </div>
            </div>
            <!-- Reports Section -->
            <div id="reports" class="section">
                <h3>Reports</h3>
                
                <div class="card">
                    <h4>Generate Reports</h4>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label for="reportClass">Class:</label>
                                <select id="reportClass">
                                    <option value="">Select Class</option>
                                </select>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label for="reportType">Report Type:</label>
                                <select id="reportType">
                                    <option value="daily">Daily Report</option>
                                    <option value="weekly">Weekly Report</option>
                                    <option value="monthly">Monthly Report</option>
                                    <option value="yearly">Yearly Report</option>
                                </select>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label for="reportStartDate">Start Date:</label>
                                <input type="date" id="reportStartDate">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label for="reportEndDate">End Date:</label>
                                <input type="date" id="reportEndDate">
                            </div>
                        </div>
                        <div class="col">
                            <button class="btn btn-primary" onclick="generateReport()">Generate Report</button>
                        </div>
                    </div>
                </div>

                <div id="reportResults">
                    <!-- Report results will appear here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addStudentModal')">&times;</span>
            <h3>Add New Student</h3>
            <form id="addStudentForm">
                <div class="form-group">
                    <label for="newStudentId">Student ID:</label>
                    <input type="text" id="newStudentId" required>
                </div>
                <div class="form-group">
                    <label for="newStudentName">Student Name:</label>
                    <input type="text" id="newStudentName" required>
                </div>
                <div class="form-group">
                    <label for="newStudentClass">Class:</label>
                    <select id="newStudentClass" required>
                        <option value="">Select Class</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="newStudentEmail">Email:</label>
                    <input type="email" id="newStudentEmail">
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addStudentModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Student</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Batch Modal -->
    <div id="addBatchModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addBatchModal')">&times;</span>
            <h3>Create New Batch</h3>
            <form id="addBatchForm">
                <div class="form-group">
                    <label for="newBatchName">Batch Name:</label>
                    <input type="text" id="newBatchName" required>
                </div>
                <div class="form-group">
                    <label for="newBatchSubjects">Subjects (comma separated):</label>
                    <input type="text" id="newBatchSubjects" required>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addBatchModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Batch</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Add Notice Modal -->
    <div id="addNoticeModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('addNoticeModal')">&times;</span>
            <h3>Create New Notice</h3>
            <form id="addNoticeForm">
                <div class="form-group">
                    <label for="noticeTitle">Title:</label>
                    <input type="text" id="noticeTitle" required>
                </div>
                <div class="form-group">
                    <label for="noticeType">Type:</label>
                    <select id="noticeType" required>
                        <option value="general">General</option>
                        <option value="homework">Homework</option>
                        <option value="announcement">Announcement</option>
                        <option value="event">Event</option>
                    </select>
                </div>
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label for="noticeTargetClass">Target Class:</label>
                            <select id="noticeTargetClass">
                                <option value="">All Classes</option>
                            </select>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label for="noticePriority">Priority:</label>
                            <select id="noticePriority">
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="noticeContent">Content:</label>
                    <textarea id="noticeContent" rows="5" required></textarea>
                </div>
                <div class="form-group">
                    <label for="noticeExpiryDate">Expiry Date (optional):</label>
                    <input type="date" id="noticeExpiryDate">
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addNoticeModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Notice</button>
                </div>
            </form>
        </div>
    </div>
    <script>
        let currentUser = null;
        let authToken = null;
        let studentsAttendance = {};
        const API_BASE = window.location.origin + '/api';

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Get authentication data
            authToken = localStorage.getItem('authToken');
            currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            if (!authToken || !currentUser || currentUser.role !== 'teacher') {
                window.location.href = '/';
                return;
            }
            
            // Set teacher info
            document.getElementById('teacherName').textContent = currentUser.name || 'Teacher';
            document.getElementById('teacherSubject').textContent = currentUser.subject || 'Multiple';
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('myAttendanceDate').value = today;
            document.getElementById('attendanceDate').value = today;
            
            // Set default date range for reports
            document.getElementById('reportStartDate').value = today;
            document.getElementById('reportEndDate').value = today;
            
            // Load initial data
            loadDashboardData();
            loadClasses();
        });

        // API helper function
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken
                }
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(API_BASE + endpoint, options);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage = 'Something went wrong';
                    
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.error || errorMessage;
                    } catch (e) {
                        errorMessage = 'Server error: ' + response.status;
                    }
                    
                    throw new Error(errorMessage);
                }
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Navigation functions
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName).classList.add('active');
            event.target.classList.add('active');
            
            // Load section-specific data
            switch(sectionName) {
                case 'overview':
                    loadDashboardData();
                    break;
                case 'myAttendance':
                    loadMyAttendance();
                    break;
                case 'manageStudents':
                    loadStudentsList();
                    break;
                case 'manageBatches':
                    loadBatches();
                    break;
                case 'markAttendance':
                    loadClasses();
                    break;
                case 'notices':
                    loadNotices();
                    break;
                case 'reports':
                    loadReportClasses();
                    break;
            }
        }

        // Dashboard data loading
        async function loadDashboardData() {
            try {
                const data = await apiCall('/dashboard');
                
                document.getElementById('totalClasses').textContent = data.stats?.totalClasses || 0;
                document.getElementById('totalStudents').textContent = data.stats?.totalStudents || 0;
                
                // Load today's attendance count
                const today = new Date().toISOString().split('T')[0];
                try {
                    const todayAttendance = await apiCall('/attendance?date=' + today);
                    const teacherTodayAttendance = todayAttendance.filter(record => record.markedBy === currentUser.userId);
                    document.getElementById('todayAttendance').textContent = teacherTodayAttendance.length;
                } catch (error) {
                    console.error('Error loading today attendance:', error);
                    document.getElementById('todayAttendance').textContent = 0;
                }
                
                // Load recent activities
                const recentActivities = document.getElementById('recentActivities');
                if (data.recentAttendance && data.recentAttendance.length > 0) {
                    recentActivities.innerHTML = data.recentAttendance.slice(0, 5).map(record => 
                        '<div style="padding: 10px; border-bottom: 1px solid #eee;">' +
                        '<strong>' + record.studentName + '</strong> - ' + record.class + ' - ' +
                        '<span style="color: ' + (record.status === 'present' ? 'green' : record.status === 'absent' ? 'red' : 'orange') + '">' +
                        record.status.toUpperCase() +
                        '</span>' +
                        '<small style="float: right; color: #666;">' + new Date(record.markedAt).toLocaleString() + '</small>' +
                        '</div>'
                    ).join('');
                } else {
                    recentActivities.innerHTML = '<p>No recent activities</p>';
                }
                
                // Load teacher attendance percentage
                loadMyAttendancePercentage();
                
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
                showAlert('Failed to load dashboard data: ' + error.message, 'error');
            }
        }

        // My Attendance functions
        async function loadMyAttendancePercentage() {
            try {
                const attendance = await apiCall('/teacher-attendance?teacherId=' + currentUser.userId);
                
                // Calculate monthly attendance percentage
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                const monthlyAttendance = attendance.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate.getMonth() === currentMonth && recordDate.getFullYear() === currentYear;
                });
                
                const workingDays = new Date(currentYear, currentMonth + 1, 0).getDate();
                const presentDays = monthlyAttendance.filter(record => record.status === 'present').length;
                const percentage = workingDays > 0 ? ((presentDays / workingDays) * 100).toFixed(1) : 0;
                
                document.getElementById('myAttendancePercent').textContent = percentage + '%';
                
            } catch (error) {
                console.error('Failed to load teacher attendance percentage:', error);
                document.getElementById('myAttendancePercent').textContent = '0%';
            }
        }

        async function loadMyAttendance() {
            try {
                const attendance = await apiCall('/teacher-attendance?teacherId=' + currentUser.userId);
                
                // Display attendance history
                const historyContainer = document.getElementById('myAttendanceHistory');
                if (attendance.length > 0) {
                    historyContainer.innerHTML = 
                        '<table class="table">' +
                        '<thead>' +
                        '<tr>' +
                        '<th>Date</th>' +
                        '<th>Status</th>' +
                        '<th>Marked At</th>' +
                        '</tr>' +
                        '</thead>' +
                        '<tbody>' +
                        attendance.slice(0, 30).map(record => 
                            '<tr>' +
                            '<td>' + new Date(record.date).toLocaleDateString() + '</td>' +
                            '<td>' +
                            '<span style="color: ' + (record.status === 'present' ? 'green' : record.status === 'absent' ? 'red' : 'orange') + '">' +
                            record.status.toUpperCase() +
                            '</span>' +
                            '</td>' +
                            '<td>' + new Date(record.markedAt).toLocaleString() + '</td>' +
                            '</tr>'
                        ).join('') +
                        '</tbody>' +
                        '</table>';
                } else {
                    historyContainer.innerHTML = '<p>No attendance records found.</p>';
                }
                
            } catch (error) {
                console.error('Failed to load my attendance:', error);
                document.getElementById('myAttendanceHistory').innerHTML = '<p>Failed to load attendance history: ' + error.message + '</p>';
            }
        }

        async function markMyAttendance() {
            const date = document.getElementById('myAttendanceDate').value;
            const status = document.getElementById('myAttendanceStatus').value;
            
            if (!date) {
                showAlert('Please select a date', 'error');
                return;
            }
            
            try {
                await apiCall('/teacher-attendance/mark', 'POST', {
                    teacherId: currentUser.userId,
                    date: date,
                    status: status
                });
                
                showAlert('Attendance marked successfully!', 'success');
                loadMyAttendance();
                loadDashboardData();
                
            } catch (error) {
                showAlert('Failed to mark attendance: ' + error.message, 'error');
            }
        }

        // Student Attendance functions
        async function loadClasses() {
            try {
                const classes = await apiCall('/classes');
                const teacherClasses = classes.filter(cls => cls.teacher === currentUser.userId);
                
                // Populate class dropdowns
                const classSelects = [
                    'attendanceClass', 
                    'studentClassFilter', 
                    'newStudentClass',
                    'reportClass',
                    'noticeClassFilter',
                    'noticeTargetClass'
                ];
                classSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = '<option value="">Select Class</option>' +
                            teacherClasses.map(cls => 
                                '<option value="' + cls.className + '">' + cls.className + '</option>'
                            ).join('');
                    }
                });
                
            } catch (error) {
                console.error('Failed to load classes:', error);
                showAlert('Failed to load classes: ' + error.message, 'error');
            }
        }
        // Teacher Attendance functions (inside Mark Attendance tab)
        async function submitTeacherAttendance() {
            const status = document.getElementById("teacherStatusSelect").value;
            const date = document.getElementById("attendanceDate").value;

            if (!status) {
                showAlert("Please select a status before submitting.", "error");
                return;
            }

            try {
                await apiCall('/teacher-attendance/mark', 'POST', {
                teacherId: currentUser.userId,
                date: date,
                status: status
                });

                showAlert("Your attendance marked successfully!", "success");
                loadMyAttendance();      // refresh history
                loadDashboardData();     // refresh overview stats
            } catch (err) {
                console.error("Error:", err);
                showAlert("Error marking attendance. Try again.", "error");
            }
        }

        async function loadStudentsForAttendance() {
            const className = document.getElementById('attendanceClass').value;
            const container = document.getElementById('studentsForAttendance');
            const submitBtn = document.getElementById('submitAttendanceBtn');
    
            if (!className) {
                container.innerHTML = '';
                submitBtn.style.display = 'none';
                return;
            }
    
            try {
                container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading students...</div>';
        
                const students = await apiCall('/students/' + className);
                studentsAttendance = {};
        
                if (students.length > 0) {
                    
                    container.innerHTML = `
    <div class="bulk-actions" style="margin-bottom: 10px;">
        <button class="btn btn-success" onclick="markAllStudents('present')">Mark All Present</button>
        <button class="btn btn-danger" onclick="markAllStudents('absent')">Mark All Absent</button>
    </div>
    <div class="table-container">
        <table class="table" id="attendanceTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Present</th>
                    <th>Absent</th>
                    <th>Late</th>
                </tr>
            </thead>
            <tbody>
                ${students.map(stu => `
                    <tr id="row-${stu.userId}">
                        <td>${stu.userId}</td>
                        <td>${stu.name}</td>
                        <td class="attendance-cell present selected" onclick="markStudentAttendance('${stu.userId}', '${stu.name}', 'present', this)"></td>
                        <td class="attendance-cell absent" onclick="markStudentAttendance('${stu.userId}', '${stu.name}', 'absent', this)"></td>
                        <td class="attendance-cell late" onclick="markStudentAttendance('${stu.userId}', '${stu.name}', 'late', this)"></td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    </div>
    <div class="mobile-card-list">
        ${students.map(stu => `
            <div class="mobile-card">
                <div class="mobile-card-header">${stu.name} (${stu.userId})</div>
                <div style="display: flex; gap: 5px; margin-top: 10px;">
                    <button class="btn btn-success btn-sm mobile-attendance-btn selected" onclick="markStudentAttendance('${stu.userId}', '${stu.name}', 'present', this)" data-student="${stu.userId}">Present</button>
                    <button class="btn btn-danger btn-sm mobile-attendance-btn" onclick="markStudentAttendance('${stu.userId}', '${stu.name}', 'absent', this)" data-student="${stu.userId}">Absent</button>
                    <button class="btn btn-warning btn-sm mobile-attendance-btn" onclick="markStudentAttendance('${stu.userId}', '${stu.name}', 'late', this)" data-student="${stu.userId}">Late</button>
                </div>
            </div>
        `).join('')}
    </div>
`;

                    // default mark all present
                    students.forEach(stu => {
                        studentsAttendance[stu.userId] = { studentId: stu.userId, studentName: stu.name, status: 'present' };
                    });

                    submitBtn.style.display = 'block';
                } else {
                    container.innerHTML = '<p>No students found in this class.</p>';
                    submitBtn.style.display = 'none';
                }
        
            } catch (error) {
                console.error('Failed to load students:', error);
                container.innerHTML = '<p>Failed to load students: ' + error.message + '</p>';
                submitBtn.style.display = 'none';
            }
        }
function markStudentAttendance(studentId, studentName, status, element) {
    studentsAttendance[studentId] = { studentId, studentName, status };

    // Handle desktop table
    const row = element.closest('tr');
    if (row) {
        row.querySelectorAll('.attendance-cell').forEach(td => td.classList.remove('selected'));
        element.classList.add('selected');
    }
    
    // Handle mobile cards
    const mobileCard = element.closest('.mobile-card');
    if (mobileCard) {
        mobileCard.querySelectorAll('.mobile-attendance-btn').forEach(btn => btn.classList.remove('selected'));
        element.classList.add('selected');
    }
}
        function markAllStudents(status) {
            document.querySelectorAll('#attendanceTable tbody tr').forEach(row => {
            const id = row.cells[0].textContent;
            const name = row.cells[1].textContent;
        
            // Remove 'selected' class from all cells in this row
            row.querySelectorAll('.attendance-cell').forEach(cell => cell.classList.remove('selected'));
        
            // Add 'selected' class to the appropriate cell based on status
            let cell;
            if (status === 'present') {
                cell = row.cells[2];
                cell.classList.add('selected');
            }
            if (status === 'absent') {
                cell = row.cells[3];
                cell.classList.add('selected');
            }
            if (status === 'late') {
                cell = row.cells[4];
                cell.classList.add('selected');
            }
        
        // Update the attendance data
        markStudentAttendance(id, name, status, cell);
    });
}
        async function submitAttendance() {
            const className = document.getElementById('attendanceClass').value;
            const date = document.getElementById('attendanceDate').value;
            const subject = document.getElementById('attendanceSubject').value;
            
            if (!className || !date || !subject) {
                showAlert('Please fill in all fields', 'error');
                return;
            }
            
            if (Object.keys(studentsAttendance).length === 0) {
                showAlert('No students to mark attendance for', 'error');
                return;
            }
            
            try {
                await apiCall('/attendance/mark', 'POST', {
                    students: Object.values(studentsAttendance),
                    date: date,
                    subject: subject,
                    class: className
                });
                
                showAlert('Attendance submitted successfully!', 'success');
                loadDashboardData(); // Refresh dashboard stats
                
            } catch (error) {
                console.error('Failed to submit attendance:', error);
                showAlert('Failed to submit attendance: ' + error.message, 'error');
            }
        }

        // Student Management functions
        async function loadStudentsList() {
            const classFilter = document.getElementById('studentClassFilter').value;
            const container = document.getElementById('studentsList');
            
            try {
                container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading students...</div>';
                
                const students = await apiCall('/students' + (classFilter ? '?classFilter=' + classFilter : ''));
                
                if (students.length > 0) {
                    container.innerHTML = 
                        '<table class="table">' +
                        '<thead>' +
                        '<tr>' +
                        '<th>Student ID</th>' +
                        '<th>Name</th>' +
                        '<th>Class</th>' +
                        '<th>Email</th>' +
                        '<th>Actions</th>' +
                        '</tr>' +
                        '</thead>' +
                        '<tbody>' +
                        students.map(student => 
                            '<tr>' +
                            '<td>' + student.userId + '</td>' +
                            '<td>' + student.name + '</td>' +
                            '<td>' + (student.class || 'N/A') + '</td>' +
                            '<td>' + (student.email || 'N/A') + '</td>' +
                            '<td>' +
                            '<button class="btn btn-danger btn-sm" onclick="deleteStudent(\'' + student.userId + '\')">Delete</button>' +
                            '</td>' +
                            '</tr>'
                        ).join('') +
                        '</tbody>' +
                        '</table>';
                } else {
                    container.innerHTML = '<p>No students found.</p>';
                }
                
            } catch (error) {
                console.error('Failed to load students:', error);
                container.innerHTML = '<p>Failed to load students: ' + error.message + '</p>';
            }
        }

        async function deleteStudent(studentId) {
            if (!confirm('Are you sure you want to delete this student?')) {
                return;
            }
            
            try {
                await apiCall('/students/' + studentId, 'DELETE');
                showAlert('Student deleted successfully!', 'success');
                loadStudentsList();
                loadDashboardData(); // Refresh stats
                
            } catch (error) {
                console.error('Failed to delete student:', error);
                showAlert('Failed to delete student: ' + error.message, 'error');
            }
        }

        function showAddStudentModal() {
            document.getElementById('addStudentModal').style.display = 'block';
        }

        // Batch Management functions
        async function loadBatches() {
            const container = document.getElementById('batchesList');
            
            try {
                container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading batches...</div>';
                
                const classes = await apiCall('/classes');
                
                if (classes.length > 0) {
                    container.innerHTML = 
                        '<div class="stats-grid">' +
                        classes.map(cls => 
                            '<div class="stat-card">' +
                            '<h4>' + cls.className + '</h4>' +
                            '<p><strong>Students:</strong> ' + cls.students.length + '</p>' +
                            '<p><strong>Subjects:</strong> ' + (cls.subjects ? cls.subjects.join(', ') : 'N/A') + '</p>' +
                            '<p><strong>Created:</strong> ' + new Date(cls.createdAt).toLocaleDateString() + '</p>' +
                            '<div style="margin-top: 10px;">' +
                            '<button class="btn btn-danger btn-sm" onclick="deleteClass(\'' + cls._id + '\')">Delete</button>' +
                            '</div>' +
                            '</div>'
                        ).join('') +
                        '</div>';
                } else {
                    container.innerHTML = '<p>No batches found.</p>';
                }
                
            } catch (error) {
                console.error('Failed to load batches:', error);
                container.innerHTML = '<p>Failed to load batches: ' + error.message + '</p>';
            }
        }

        async function deleteClass(classId) {
            if (!confirm('Are you sure you want to delete this class?')) {
                return;
            }
            
            try {
                await apiCall('/classes/' + classId, 'DELETE');
                showAlert('Class deleted successfully!', 'success');
                loadBatches();
                loadClasses(); // Refresh dropdowns
                loadDashboardData(); // Refresh stats
                
            } catch (error) {
                console.error('Failed to delete class:', error);
                showAlert('Failed to delete class: ' + error.message, 'error');
            }
        }

        function showAddBatchModal() {
            document.getElementById('addBatchModal').style.display = 'block';
        }

        // Reports functions
        async function loadReportClasses() {
            try {
                const classes = await apiCall('/classes');
                const select = document.getElementById('reportClass');
                
                select.innerHTML = '<option value="">All Classes</option>' +
                    classes.map(cls => 
                        '<option value="' + cls.className + '">' + cls.className + '</option>'
                    ).join('');
                    
            } catch (error) {
                console.error('Failed to load report classes:', error);
            }
        }

        async function generateReport() {
            const className = document.getElementById('reportClass').value;
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const container = document.getElementById('reportResults');
            
            if (!startDate || !endDate) {
                showAlert('Please select start and end dates', 'error');
                return;
            }
            
            try {
                container.innerHTML = '<div class="loading"><div class="spinner"></div>Generating report...</div>';
                
                let queryParams = '?startDate=' + startDate + '&endDate=' + endDate;
                if (className) queryParams += '&className=' + className;
                queryParams += '&reportType=' + reportType;
                
                const reportData = await apiCall('/reports/attendance' + queryParams);
                
                if (reportData.length > 0) {
                    container.innerHTML = 
                        '<div class="card">' +
                        '<h4>Attendance Report (' + reportType + ')</h4>' +
                        '<table class="table">' +
                        '<thead>' +
                        '<tr>' +
                        '<th>Student ID</th>' +
                        '<th>Name</th>' +
                        '<th>Class</th>' +
                        '<th>Total Days</th>' +
                        '<th>Present</th>' +
                        '<th>Absent</th>' +
                        '<th>Late</th>' +
                        '<th>Attendance %</th>' +
                        '</tr>' +
                        '</thead>' +
                        '<tbody>' +
                        reportData.map(record => 
                            '<tr>' +
                            '<td>' + record._id + '</td>' +
                            '<td>' + record.studentName + '</td>' +
                            '<td>' + record.class + '</td>' +
                            '<td>' + record.totalDays + '</td>' +
                            '<td style="color: green;">' + record.presentDays + '</td>' +
                            '<td style="color: red;">' + record.absentDays + '</td>' +
                            '<td style="color: orange;">' + record.lateDays + '</td>' +
                            '<td><strong>' + record.attendancePercentage.toFixed(1) + '%</strong></td>' +
                            '</tr>'
                        ).join('') +
                        '</tbody>' +
                        '</table>' +
                        '</div>';
                } else {
                    container.innerHTML = '<p>No data found for the selected criteria.</p>';
                }
                
            } catch (error) {
                console.error('Failed to generate report:', error);
                container.innerHTML = '<p>Failed to generate report: ' + error.message + '</p>';
            }
        }

        // Modal functions
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Form submission handlers
        document.getElementById('addStudentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const studentData = {
                userId: document.getElementById('newStudentId').value,
                password: 'student123', // Default password
                role: 'student',
                name: document.getElementById('newStudentName').value,
                class: document.getElementById('newStudentClass').value,
                email: document.getElementById('newStudentEmail').value
            };
            
            try {
                await apiCall('/register', 'POST', studentData);
                showAlert('Student added successfully!', 'success');
                closeModal('addStudentModal');
                this.reset();
                loadStudentsList();
                loadDashboardData();
                
            } catch (error) {
                console.error('Failed to add student:', error);
                showAlert('Failed to add student: ' + error.message, 'error');
            }
        });

        document.getElementById('addBatchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const batchData = {
                className: document.getElementById('newBatchName').value,
                subjects: document.getElementById('newBatchSubjects').value
            };
            
            try {
                await apiCall('/classes', 'POST', batchData);
                showAlert('Batch created successfully!', 'success');
                closeModal('addBatchModal');
                this.reset();
                loadBatches();
                loadClasses();
                loadDashboardData();
                
            } catch (error) {
                console.error('Failed to create batch:', error);
                showAlert('Failed to create batch: ' + error.message, 'error');
            }
        });

        // Utility functions
        function showAlert(message, type) {
            // Try to find existing alert in current section
            const activeSection = document.querySelector('.section.active');
            let alertElement = activeSection ? activeSection.querySelector('.alert') : null;
            
            // If no alert found, create one
            if (!alertElement) {
                alertElement = document.createElement('div');
                alertElement.className = 'alert';
                if (activeSection) {
                    activeSection.insertBefore(alertElement, activeSection.firstChild);
                }
            }
            
            alertElement.className = 'alert ' + type + ' show';
            alertElement.textContent = message;
            
            setTimeout(() => {
                alertElement.classList.remove('show');
            }, 5000);
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            window.location.href = '/';
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
        // Notice Management functions
        async function loadNotices() {
            const classFilter = document.getElementById('noticeClassFilter').value;
            const typeFilter = document.getElementById('noticeTypeFilter').value;
            const container = document.getElementById('noticesList');
    
                try {
                    container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading notices...</div>';
        
                    let queryParams = '';
                    if (classFilter) queryParams += '?targetClass=' + classFilter;
                    if (typeFilter) queryParams += (queryParams ? '&' : '?') + 'type=' + typeFilter;
        
                    const notices = await apiCall('/notices' + queryParams);
                
                    if (notices.length > 0) {
                        container.innerHTML = notices.map(notice => {
                            const priorityColor = notice.priority === 'high' ? '#dc3545' : 
                                                    notice.priority === 'medium' ? '#ffc107' : '#28a745';
                            const typeIcon = notice.type === 'homework' ? '📚' : 
                                            notice.type === 'announcement' ? '📢' : 
                                            notice.type === 'event' ? '📅' : '📝';
                        
                            return `
                            <div class="card" style="margin-bottom: 15px; border-left: 4px solid ${priorityColor};">
                                <div class="row">
                                    <div class="col" style="flex: 2;">
                                        <h4>${typeIcon} ${notice.title}</h4>
                                        <p><strong>Type:</strong> ${notice.type.charAt(0).toUpperCase() + notice.type.slice(1)}</p>
                                        <p><strong>Class:</strong> ${notice.targetClass || 'All Classes'}</p>
                                        <p><strong>Priority:</strong> 
                                            <span style="color: ${priorityColor}; font-weight: bold;">
                                                ${notice.priority.toUpperCase()}
                                            </span>
                                        </p>
                                        <p><strong>Posted:</strong> ${new Date(notice.createdAt).toLocaleString()}</p>
                                        ${notice.expiryDate ? `<p><strong>Expires:</strong> ${new Date(notice.expiryDate).toLocaleString()}</p>` : ''}
                                    </div>
                                    <div class="col" style="flex: 3;">
                                        <p><strong>Content:</strong></p>
                                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                                            ${notice.content.replace(/\n/g, '<br>')}
                                        </div>
                                        <div style="text-align: right;">
                                            <button class="btn btn-warning btn-sm" onclick="editNotice('${notice._id}')">Edit</button>
                                            <button class="btn btn-danger btn-sm" onclick="deleteNotice('${notice._id}')">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<p>No notices found.</p>';
                }
            
            } catch (error) {
                console.error('Failed to load notices:', error);
                container.innerHTML = '<p>Failed to load notices: ' + error.message + '</p>';
            }
        }

        function showAddNoticeModal() {
            document.getElementById('addNoticeModal').style.display = 'block';
        }

        async function deleteNotice(noticeId) {
            if (!confirm('Are you sure you want to delete this notice?')) {
                return;
            }
    
            try {
                await apiCall('/notices/' + noticeId, 'DELETE');
                showAlert('Notice deleted successfully!', 'success');
                loadNotices();
        
            } catch (error) {
                console.error('Failed to delete notice:', error);
                showAlert('Failed to delete notice: ' + error.message, 'error');
            }
        }
        // Add this function to your teacher-dashboard.html JavaScript section
        let editingNoticeId = null;

        async function editNotice(noticeId) {
        try {
            // Get the notice data (you'll need to store it or fetch it)
            const notices = await apiCall('/notices');
            const notice = notices.find(n => n._id === noticeId);
        
            if (!notice) {
                showAlert('Notice not found', 'error');
                return;
            }
        
            // Fill the form with existing data
            document.getElementById('noticeTitle').value = notice.title;
            document.getElementById('noticeType').value = notice.type;
            document.getElementById('noticeTargetClass').value = notice.targetClass || '';
            document.getElementById('noticePriority').value = notice.priority;
            document.getElementById('noticeContent').value = notice.content;
            if (notice.expiryDate) {
                document.getElementById('noticeExpiryDate').value = new Date(notice.expiryDate).toISOString().split('T')[0];
            }
        
            // Store the editing ID and change modal title
            editingNoticeId = noticeId;
            document.querySelector('#addNoticeModal h3').textContent = 'Edit Notice';
            document.querySelector('#addNoticeForm button[type="submit"]').textContent = 'Update Notice';
        
            // Show modal
            document.getElementById('addNoticeModal').style.display = 'block';
        
        } catch (error) {
            console.error('Failed to load notice for editing:', error);
            showAlert('Failed to load notice: ' + error.message, 'error');
        }
    }
        // Form submission handler
        document.getElementById('addNoticeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
    
            const noticeData = {
                title: document.getElementById('noticeTitle').value,
                content: document.getElementById('noticeContent').value,
                type: document.getElementById('noticeType').value,
                targetClass: document.getElementById('noticeTargetClass').value,
                priority: document.getElementById('noticePriority').value,
                expiryDate: document.getElementById('noticeExpiryDate').value
            };
    
            try {
                if (editingNoticeId) {
                    // Update existing notice
                    await apiCall('/notices/' + editingNoticeId, 'PUT', noticeData);
                    showAlert('Notice updated successfully!', 'success');
                } else {
                    // Create new notice
                    await apiCall('/notices', 'POST', noticeData);
                    showAlert('Notice created successfully!', 'success');
                }
        
                closeModal('addNoticeModal');
                this.reset();
                editingNoticeId = null;
        
                // Reset modal title
                document.querySelector('#addNoticeModal h3').textContent = 'Create New Notice';
                document.querySelector('#addNoticeForm button[type="submit"]').textContent = 'Create Notice';
        
                loadNotices();
        
            } catch (error) {
                console.error('Failed to create notice:', error);
                showAlert('Failed to create notice: ' + error.message, 'error');
            }
        });
    </script>
</body>
</html>